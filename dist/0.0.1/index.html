<!DOCTYPE html>
<html>
  <head>
    <meta charset = "UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>toSocial Card</title>
    <link rel="stylesheet" type="text/css" href="card.min.css">
  </head>
  <body>
    <div id="proto_toSocial_card"></div>
    <script src="https://d2m6lzru8erw1k.cloudfront.net/lib/oasis.min.js"></script>
    <script src="card.min.js"></script>
    <script type="text/javascript">
    var x = new ProtoGraph.Card.toSocial();
    let param = location.search.split('HtmlCast_Unique_Identifier=')[1]
    function get(url) {
      return new Promise(function(resolve, reject) {
        var req = new XMLHttpRequest();
        req.open('GET', url);
        req.onload = function() {
          if (req.status == 200) {
            resolve(req.response);
          }
          else {
            reject(Error(req.statusText));
          }
        };
        req.onerror = function() {
          reject(Error("Network Error"));
        };
        req.send();
      });
    }

    var ReceiverConsumer = Oasis.Consumer.extend({
      requests: {
        receive: function(mode) {
          get('https://3fc38481.ngrok.io/api/v1/view_casts/'+param).then(function (response) {
            let response_object = JSON.parse(response);
            x.init({
              selector: document.querySelector('#proto_toSocial_card'),
              data_url: response_object.data_url,
              schema_url: response_object.schema_json
            });
            renderWithMode(mode);
          }, function(error) {
            console.error("Failed!", error);
          });
        }
      },
      events: {
        get_size: function(){
          var that = this;
          var intervalId = setInterval(function(){
            clientRect = x.getData();
            if(clientRect.height){
              var height = clientRect.height,
                width = clientRect.width;
              that.send("resize_frame", {height: height, width: width});
              clearInterval(intervalId);
            }
          }, 10)
        },
        change_mode: function(mode){
          renderWithMode(mode);
          var that = this;
          setTimeout(function(){
            height = x.getData().height;
            that.send("resize_frame", {height: height});
          })
        }
      }
    });
    oasis.connect({
      consumers: {
        receive: ReceiverConsumer
      }
    });

    function renderWithMode(mode) {
      switch(mode){
        case "facebook":
        case "twitter":
          x.renderFacebookCard();
          break;
        case "instagram":
          x.renderInstagramCard();
          break;
      }
    }
    </script>
  </body>
</html>